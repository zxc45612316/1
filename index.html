<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>台股模擬交易平台</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; background: linear-gradient(135deg, #e0f7fa, #ffffff); }
    h1 { text-align: center; color: #006064; margin-bottom: 30px; }
    .wallet, .history, .stock-item, .search-bar { background: #ffffff; padding: 20px; margin: 10px auto; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); max-width: 800px; }
    .wallet { text-align: center; font-size: 1.5em; font-weight: bold; color: #004d40; }
    .stock-list { margin-top: 20px; display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; }
    .stock-item { width: 250px; transition: transform 0.3s ease; }
    .stock-item:hover { transform: translateY(-5px); }
    button { padding: 8px 12px; margin: 5px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
    .buy { background-color: #4caf50; color: white; }
    .sell { background-color: #f44336; color: white; }
    input[type=number] { width: 60px; padding: 5px; text-align: center; border: 1px solid #ccc; border-radius: 8px; margin-top: 5px; }
    table { width: 100%; margin-top: 20px; border-collapse: collapse; }
    th, td { padding: 10px; border-bottom: 1px solid #ddd; text-align: center; }
    tr:hover { background-color: #f1f1f1; }
    .search-bar input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #bbb; font-size: 1em; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
    .modal-content { background: white; padding: 20px; border-radius: 12px; width: 90%; max-width: 600px; }
  </style>
</head>
<body>
  <h1>台股模擬交易平台</h1>

  <div class="wallet">
    資金餘額：<span id="cash">100000</span> 元
  </div>

  <div class="search-bar">
    <input type="text" id="searchInput" placeholder="搜尋股票代碼" oninput="searchStock()">
  </div>

  <div class="stock-list" id="stock-list"></div>

  <div class="history">
    <h2>交易紀錄</h2>
    <table>
      <thead>
        <tr>
          <th>時間</th>
          <th>動作</th>
          <th>股票</th>
          <th>數量</th>
          <th>單價</th>
        </tr>
      </thead>
      <tbody id="history-body"></tbody>
    </table>
  </div>

  <div id="modal" class="modal" onclick="closeModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
      <canvas id="chart"></canvas>
    </div>
  </div>

  <script>
    const popularStocks = [
      { name: "台積電", code: "2330", price: 600 },
      { name: "鴻海", code: "2317", price: 110 },
      { name: "聯發科", code: "2454", price: 900 }
    ];
    const stocks = [...popularStocks];
    let cash = localStorage.getItem('cash') ? parseFloat(localStorage.getItem('cash')) : 100000;
    let portfolio = localStorage.getItem('portfolio') ? JSON.parse(localStorage.getItem('portfolio')) : {};
    let history = localStorage.getItem('history') ? JSON.parse(localStorage.getItem('history')) : [];
    let priceHistory = {};

    function saveData() {
      localStorage.setItem('cash', cash);
      localStorage.setItem('portfolio', JSON.stringify(portfolio));
      localStorage.setItem('history', JSON.stringify(history));
      localStorage.setItem('priceHistory', JSON.stringify(priceHistory));
    }

    function updateDisplay() {
      document.getElementById('cash').innerText = Math.floor(cash);
      const list = document.getElementById('stock-list');
      list.innerHTML = '';
      stocks.forEach(stock => {
        if (stock.visible) {
          const owned = portfolio[stock.code] || 0;
          const div = document.createElement('div');
          div.className = 'stock-item';
          div.innerHTML = `
            <div><strong><a href="#" onclick="showChart('${stock.code}');return false;">${stock.name} (${stock.code})</a></strong><br>
            現價：${Math.floor(stock.price)} 元<br>
            持有：${owned} 股<br><br>
            <input type="number" id="amount-${stock.code}" min="1" value="1"><br>
            <button class="buy" onclick="buyStock('${stock.code}')">買</button>
            <button class="sell" onclick="sellStock('${stock.code}')">賣</button></div>
          `;
          list.appendChild(div);
        }
      });
      updateHistory();
    }

    function buyStock(code) {
      const stock = stocks.find(s => s.code === code);
      const amount = parseInt(document.getElementById(`amount-${code}`).value);
      const cost = stock.price * amount;
      if (cash >= cost) {
        cash -= cost;
        portfolio[code] = (portfolio[code] || 0) + amount;
        history.unshift({ time: new Date().toLocaleString(), action: '買進', stock: stock.name, amount: amount, price: Math.floor(stock.price) });
        saveData();
        updateDisplay();
      } else {
        alert('資金不足！');
      }
    }

    function sellStock(code) {
      const stock = stocks.find(s => s.code === code);
      const amount = parseInt(document.getElementById(`amount-${code}`).value);
      if ((portfolio[code] || 0) >= amount) {
        cash += stock.price * amount;
        portfolio[code] -= amount;
        history.unshift({ time: new Date().toLocaleString(), action: '賣出', stock: stock.name, amount: amount, price: Math.floor(stock.price) });
        saveData();
        updateDisplay();
      } else {
        alert('持股不足！');
      }
    }

    function updateHistory() {
      const historyBody = document.getElementById('history-body');
      historyBody.innerHTML = '';
      history.forEach(record => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${record.time}</td>
          <td>${record.action}</td>
          <td>${record.stock}</td>
          <td>${record.amount}</td>
          <td>${record.price}</td>
        `;
        historyBody.appendChild(tr);
      });
    }

    function fluctuatePrices() {
      stocks.forEach(stock => {
        let change = (Math.random() - 0.5) * 10;
        stock.price += change;
        if (stock.price < 1) stock.price = 1;
        if (!priceHistory[stock.code]) priceHistory[stock.code] = [];
        priceHistory[stock.code].push({ time: new Date(), price: stock.price });
        if (priceHistory[stock.code].length > 1440) { // 保留1天的記錄
          priceHistory[stock.code].shift();
        }
      });
      saveData();
      updateDisplay();
    }

    function searchStock() {
      const input = document.getElementById('searchInput').value.trim();
      stocks.forEach(stock => {
        stock.visible = stock.code.includes(input) || input === '';
      });
      updateDisplay();
    }

    let chart;
    function showChart(code) {
      const modal = document.getElementById('modal');
      modal.style.display = 'flex';
      const ctx = document.getElementById('chart').getContext('2d');
      if (chart) chart.destroy();
      const data = priceHistory[code] || [];
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.map(item => new Date(item.time).toLocaleTimeString()),
          datasets: [{
            label: code + ' 走勢圖',
            data: data.map(item => item.price),
            borderColor: 'blue',
            backgroundColor: 'lightblue',
            fill: false
          }]
        },
        options: {
          responsive: true,
          scales: {
            x: { display: true },
            y: { display: true }
          }
        }
      });
    }

    function closeModal() {
      document.getElementById('modal').style.display = 'none';
    }

    stocks.forEach(stock => stock.visible = true);
    if (localStorage.getItem('priceHistory')) {
      priceHistory = JSON.parse(localStorage.getItem('priceHistory'));
    }
    updateDisplay();
    setInterval(fluctuatePrices, 10000);
  </script>
</body>
</html>
